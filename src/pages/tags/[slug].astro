---
import { getCollection, type CollectionEntry } from "astro:content";
import Layout from "../../components/layout.astro";
import PostListing from "../../components/post/post-list.astro";
import SlugList from "../../components/slug-list.astro";

type Post = CollectionEntry<"blog">;

export async function getStaticPaths() {
  const posts = await getCollection("blog");
  const tagSet = new Set<string>();
  const tagMap = posts.reduce(
    (map, post) => {
      const tags = post.data.tags;
      if (tags?.length) {
        tags.forEach((tag) => {
          tagSet.add(tag);
          map[tag] = (map[tag] || []).concat(post);
        });
      }
      return map;
    },
    {} as Record<string, Post[]>,
  );
  const tags = Array.from(tagSet).sort();
  return Object.entries(tagMap).map(([tag, posts]) => ({
    params: { slug: decodeURI(tag) },
    props: { slug: tag, posts, tags },
  }));
}
type Props = {
  slug: string;
  posts: Post[];
  tags: string[];
};

const { slug, posts, tags } = Astro.props;

// Filtrer les articles en fonction du slug
let filteredPosts = posts;

// Si le slug actif n'est pas "Archives", on exclut les articles avec le tag "Archives"
if (slug !== "Archives") {
  filteredPosts = posts.filter(post => !post.data.tags?.includes("Archives"));
}

// Trier les articles par date dÃ©croissante
const sortedPosts = filteredPosts.sort((a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime());
---

<Layout>
  <SlugList slugs={tags} activeSlug={slug} generateLink={(slug) => `/tags/${encodeURI(slug)}`} />
  <PostListing posts={sortedPosts} />
</Layout>
